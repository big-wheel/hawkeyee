{"version":3,"file":"index.js","sources":["../index.js"],"sourcesContent":["/* eslint-disable indent,no-use-before-define */\n/**\n * @file remoteStorage\n * @author Cuttle Cong\n * @date 2018/5/6\n * @description\n */\n\nimport AV from 'leancloud-storage/live-query'\nimport mark from 'markme'\n\nexport default async function markLeancloud(element, options = {}) {\n  options = {\n    enableInitialFill: true,\n    key: location.origin + location.pathname,\n    AVOptions: {},\n    enableLiveQuery: true,\n    ...options\n  }\n  // AV.\n  AV.applicationId = null\n  AV.init(options.AVOptions)\n\n  const Markme = AV.Object.extend('Markme')\n\n  const emitter = mark(element, options)\n  function toJSON(x) {\n    let { data, ...json } = x.toJSON()\n\n    return {\n      ...json,\n      ...data\n    }\n  }\n\n  const runtime = {}\n  const storage = {\n    set: async function(type, id, data) {\n      let old = await this.get(type, id)\n      let mm\n      if (old && old.objectId) {\n        mm = AV.Object.createWithoutData('Markme', old.objectId)\n      } else {\n        mm = new Markme()\n      }\n\n      mm.set('id', id)\n      mm.set('ukey', options.key)\n      mm.set('type', type)\n      mm.set('data', data)\n      runtime.set = true\n      return mm.save()\n    },\n    get: async function(type, id) {\n      const query = new AV.Query('Markme')\n      query.equalTo('type', type)\n      query.equalTo('id', id)\n      query.equalTo('ukey', options.key)\n      return (await query.find()).map(toJSON)[0]\n    },\n    remove: async function(type, id) {\n      let data = await this.get(type, id)\n      if (data.objectId) {\n        // console.error('remove', id)\n        // console.trace()\n        let rlt = AV.Query.doCloudQuery(\n          `delete from Markme where objectId=${JSON.stringify(data.objectId)}`\n        )\n        runtime.rm = true\n        return rlt\n      }\n    },\n    getLiveQuery(type) {\n      const query = new AV.Query('Markme')\n      query.equalTo('type', type)\n      query.equalTo('ukey', options.key)\n      return query\n    },\n    getAll: async function(type) {\n      const query = this.getLiveQuery(type)\n      return (await query.find()).map(toJSON)\n    },\n    getTotal: async function(type) {\n      const query = new AV.Query('Markme')\n      query.equalTo('type', type)\n      return (await query.find()).map(toJSON)\n    }\n  }\n\n  // LiveQuery\n  if (options.enableLiveQuery) {\n    const query = storage.getLiveQuery('highlight')\n    const liveQuery = await query.subscribe()\n    liveQuery\n      .on('create', created => {\n        created = created.toJSON()\n        // console.log('create', runtime, created.id, created.data)\n        if (runtime.set) {\n          delete runtime.set\n          return\n        }\n        created.id &&\n          created.data &&\n          emitter.highlight.fill(\n            { id: created.id, ...created.data }\n          )\n      })\n      .on('update', updated => {\n        updated = updated.toJSON()\n        // console.log('update', runtime, updated.id)\n        // 自己修改也会触发\n        if (runtime.set) {\n          delete runtime.set\n          return\n        }\n        // console.log('updated', updated)\n        const { words, color } = updated.data || {}\n        updated.id && emitter.highlight.change(updated.id, { color, words })\n      })\n      .on('delete', deleted => {\n        deleted = deleted.toJSON()\n        // console.log('delete', runtime, deleted.id, deleted.data)\n        if (runtime.rm) {\n          delete runtime.rm\n          return\n        }\n        // console.log('deleted', deleted)\n        emitter.highlight.remove(deleted.id)\n      })\n  }\n\n  emitter\n    .on('highlight-add', async ({ id, ...data }) => {\n      console.warn('highlight-add')\n      await storage.set('highlight', id, data)\n    })\n    .on('highlight-remove', async id => {\n      console.warn('highlight-remove')\n      storage.remove('highlight', id)\n    })\n    .on('highlight-change:words', async data => {\n      console.warn('highlight-change:words')\n      let old = await storage.get('highlight', data.id)\n      if (old) {\n        old.words = data.words\n        await storage.set('highlight', data.id, old)\n      }\n    })\n    .on('highlight-change:color', async data => {\n      console.warn('highlight-change:color')\n      let old = await storage.get('highlight', data.id)\n      if (old) {\n        old.color = data.color\n        await storage.set('highlight', data.id, old)\n      }\n    })\n    .on('highlight-match-fail', async id => {\n      // console.warn('highlight-match-fail')\n      // await storage.remove('highlight', id)\n    })\n\n  if (options.enableInitialFill) {\n    let list = await storage.getAll('highlight')\n    // if (!list || !list.length) {\n    //   storage.set('null', 'null', null)\n    // }\n    emitter.highlight.fill(list)\n  }\n\n  return emitter\n}\n"],"names":["element","options","toJSON","x","data","json","location","origin","pathname","applicationId","init","AVOptions","AV","Object","extend","mark","type","id","get","old","objectId","createWithoutData","Markme","set","key","mm","save","Query","equalTo","query","find","map","doCloudQuery","JSON","stringify","rm","rlt","getLiveQuery","enableLiveQuery","storage","subscribe","on","created","runtime","emitter","highlight","fill","updated","words","color","change","deleted","remove","warn","enableInitialFill","getAll","list","markLeancloud"],"mappings":";;;;;;;;;;;AAWA;sEAAe,mBAA6BA,OAA7B;;;QAAsCC,OAAtC,uEAAgD,EAAhD;yBAeJC,MAfI;;;;;kBAAA,YAeJA,MAfI,CAeGC,CAfH,EAeM;8BACOA,EAAED,MAAF,EADP;kBACXE,IADW,aACXA,IADW;kBACFC,IADE;;kCAIZA,IADL,EAEKD,IAFL;aAlBW;;;iCAEQ,IADrB;mBAEOE,SAASC,MAAT,GAAkBD,SAASE,QAFlC;yBAGa,EAHb;+BAImB;eACdP,OALL;;eAQGQ,aAAH,GAAmB,IAAnB;eACGC,IAAH,CAAQT,QAAQU,SAAhB;;kBAVa,GAYEC,GAAGC,MAAH,CAAUC,MAAV,CAAiB,QAAjB,CAZF;mBAAA,GAcGC,KAAKf,OAAL,EAAcC,OAAd,CAdH;mBAAA,GAwBG,EAxBH;mBAAA,GAyBG;;qFACT,iBAAee,IAAf,EAAqBC,EAArB,EAAyBb,IAAzB;;;;;;;iCACa,KAAKc,GAAL,CAASF,IAAT,EAAeC,EAAf,CADb;;;6BAAA;4BAAA;;8BAGCE,OAAOA,IAAIC,QAAf,EAAyB;iCAClBR,GAAGC,MAAH,CAAUQ,iBAAV,CAA4B,QAA5B,EAAsCF,IAAIC,QAA1C,CAAL;2BADF,MAEO;iCACA,IAAIE,MAAJ,EAAL;;;6BAGCC,GAAH,CAAO,IAAP,EAAaN,EAAb;6BACGM,GAAH,CAAO,MAAP,EAAetB,QAAQuB,GAAvB;6BACGD,GAAH,CAAO,MAAP,EAAeP,IAAf;6BACGO,GAAH,CAAO,MAAP,EAAenB,IAAf;kCACQmB,GAAR,GAAc,IAAd;2DACOE,GAAGC,IAAH,EAdJ;;;;;;;;iBAAL;;;;;;;iBADc;;qFAiBT,kBAAeV,IAAf,EAAqBC,EAArB;;;;;;+BAAA,GACW,IAAIL,GAAGe,KAAP,CAAa,QAAb,CADX;;gCAEGC,OAAN,CAAc,MAAd,EAAsBZ,IAAtB;gCACMY,OAAN,CAAc,IAAd,EAAoBX,EAApB;gCACMW,OAAN,CAAc,MAAd,EAAsB3B,QAAQuB,GAA9B;;iCACcK,MAAMC,IAAN,EALX;;;yCAK6B5B,MAL7B;2EAKyB6B,GALzB,eAKqC,CALrC;;;;;;;;iBAAL;;;;;;;iBAjBc;;qFAwBN,kBAAef,IAAf,EAAqBC,EAArB;;;;;;;iCACW,KAAKC,GAAL,CAASF,IAAT,EAAeC,EAAf,CADX;;;8BAAA;;+BAEFb,KAAKgB,QAFH;;;;;;;6BAAA,GAKMR,GAAGe,KAAH,CAASK,YAAT,wCAC6BC,KAAKC,SAAL,CAAe9B,KAAKgB,QAApB,CAD7B,CALN;;kCAQIe,EAAR,GAAa,IAAb;4DACOC,GATH;;;;;;;;iBAAR;;;;;;;iBAxBc;0BAAA,wBAoCDpB,IApCC,EAoCK;oBACXa,QAAQ,IAAIjB,GAAGe,KAAP,CAAa,QAAb,CAAd;sBACMC,OAAN,CAAc,MAAd,EAAsBZ,IAAtB;sBACMY,OAAN,CAAc,MAAd,EAAsB3B,QAAQuB,GAA9B;uBACOK,KAAP;eAxCY;;;qFA0CN,kBAAeb,IAAf;;;;;;+BAAA,GACQ,KAAKqB,YAAL,CAAkBrB,IAAlB,CADR;;iCAEQa,MAAMC,IAAN,EAFR;;;yCAE0B5B,MAF1B;2EAEsB6B,GAFtB;;;;;;;;iBAAR;;;;;;;iBA1Cc;;qFA8CJ,kBAAef,IAAf;;;;;;+BAAA,GACM,IAAIJ,GAAGe,KAAP,CAAa,QAAb,CADN;;gCAEFC,OAAN,CAAc,MAAd,EAAsBZ,IAAtB;;iCACca,MAAMC,IAAN,EAHN;;;yCAGwB5B,MAHxB;2EAGoB6B,GAHpB;;;;;;;;iBAAV;;;;;;;;;;aAvEW;;iBA+ET9B,QAAQqC,eA/EC;;;;;iBAAA,GAgFGC,QAAQF,YAAR,CAAqB,WAArB,CAhFH;;mBAiFaR,MAAMW,SAAN,EAjFb;;;qBAAA;;sBAmFRC,EADH,CACM,QADN,EACgB,mBAAW;wBACbC,QAAQxC,MAAR,EAAV;;kBAEIyC,QAAQpB,GAAZ,EAAiB;uBACRoB,QAAQpB,GAAf;;;sBAGMN,EAAR,IACEyB,QAAQtC,IADV,IAEEwC,QAAQC,SAAR,CAAkBC,IAAlB,YACI7B,IAAIyB,QAAQzB,EADhB,IACuByB,QAAQtC,IAD/B,EAFF;aARJ,EAcGqC,EAdH,CAcM,QAdN,EAcgB,mBAAW;wBACbM,QAAQ7C,MAAR,EAAV;;;kBAGIyC,QAAQpB,GAAZ,EAAiB;uBACRoB,QAAQpB,GAAf;;;;;0BAIuBwB,QAAQ3C,IAAR,IAAgB,EATlB;kBASf4C,KATe,SASfA,KATe;kBASRC,KATQ,SASRA,KATQ;;sBAUfhC,EAAR,IAAc2B,QAAQC,SAAR,CAAkBK,MAAlB,CAAyBH,QAAQ9B,EAAjC,EAAqC,EAAEgC,YAAF,EAASD,YAAT,EAArC,CAAd;aAxBJ,EA0BGP,EA1BH,CA0BM,QA1BN,EA0BgB,mBAAW;wBACbU,QAAQjD,MAAR,EAAV;;kBAEIyC,QAAQR,EAAZ,EAAgB;uBACPQ,QAAQR,EAAf;;;;sBAIMU,SAAR,CAAkBO,MAAlB,CAAyBD,QAAQlC,EAAjC;aAlCJ;;;;oBAuCCwB,EADH,CACM,eADN;mFACuB;oBAASxB,EAAT,SAASA,EAAT;oBAAgBb,IAAhB;;;;;;gCACXiD,IAAR,CAAa,eAAb;;+BACMd,QAAQhB,GAAR,CAAY,WAAZ,EAAyBN,EAAzB,EAA6Bb,IAA7B,CAFa;;;;;;;;eADvB;;;;;iBAKGqC,EALH,CAKM,kBALN;oFAK0B,kBAAMxB,EAAN;;;;;gCACdoC,IAAR,CAAa,kBAAb;gCACQD,MAAR,CAAe,WAAf,EAA4BnC,EAA5B;;;;;;;;eAPJ;;;;;iBASGwB,EATH,CASM,wBATN;oFASgC,kBAAMrC,IAAN;;;;;;gCACpBiD,IAAR,CAAa,wBAAb;;+BACgBd,QAAQrB,GAAR,CAAY,WAAZ,EAAyBd,KAAKa,EAA9B,CAFY;;;2BAAA;;6BAGxBE,GAHwB;;;;;4BAItB6B,KAAJ,GAAY5C,KAAK4C,KAAjB;;+BACMT,QAAQhB,GAAR,CAAY,WAAZ,EAAyBnB,KAAKa,EAA9B,EAAkCE,GAAlC,CALoB;;;;;;;;eAThC;;;;;iBAiBGsB,EAjBH,CAiBM,wBAjBN;oFAiBgC,kBAAMrC,IAAN;;;;;;gCACpBiD,IAAR,CAAa,wBAAb;;+BACgBd,QAAQrB,GAAR,CAAY,WAAZ,EAAyBd,KAAKa,EAA9B,CAFY;;;2BAAA;;6BAGxBE,GAHwB;;;;;4BAItB8B,KAAJ,GAAY7C,KAAK6C,KAAjB;;+BACMV,QAAQhB,GAAR,CAAY,WAAZ,EAAyBnB,KAAKa,EAA9B,EAAkCE,GAAlC,CALoB;;;;;;;;eAjBhC;;;;;iBAyBGsB,EAzBH,CAyBM,sBAzBN;oFAyB8B,mBAAMxB,EAAN;;;;;;;;;;eAzB9B;;;;;;;;;;iBA8BIhB,QAAQqD,iBAtJC;;;;;;mBAuJMf,QAAQgB,MAAR,CAAe,WAAf,CAvJN;;;gBAAA;;;;;oBA2JHV,SAAR,CAAkBC,IAAlB,CAAuBU,IAAvB;;;+CAGKZ,OA9JM;;;;;;;;GAAf;;WAA8Ba,aAA9B;;;;SAA8BA,aAA9B;;;;;"}