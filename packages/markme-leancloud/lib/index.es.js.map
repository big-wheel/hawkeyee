{"version":3,"file":"index.es.js","sources":["../index.js"],"sourcesContent":["/**\n * @file remoteStorage\n * @author Cuttle Cong\n * @date 2018/5/6\n * @description\n */\n\nimport AV from 'leancloud-storage'\nimport mark from 'markme'\n\nexport default function markInLocalStorage(element, options = {}) {\n  options = {\n    enableInitialFill: true,\n    key: location.origin + location.pathname,\n    AVOptions: {},\n    ...options\n  }\n\n  // AV.\n  AV.applicationId = null\n  AV.init(options.AVOptions)\n\n  const Markme = AV.Object.extend('Markme')\n\n  const emitter = mark(element, options)\n\n  function toJSON(x) {\n    let { data, ...json } = x.toJSON()\n\n    return {\n      ...json,\n      ...data\n    }\n  }\n\n  const storage = {\n    set: async function(type, id, data) {\n      let old = await this.get(type, id)\n      let mm\n      if (old && old.objectId) {\n        mm = AV.Object.createWithoutData('Markme', old.objectId)\n      } else {\n        mm = new Markme()\n      }\n\n      mm.set('id', id)\n      mm.set('ukey', options.key)\n      mm.set('type', type)\n      mm.set('data', data)\n      return mm.save()\n    },\n    get: async function(type, id) {\n      const query = new AV.Query('Markme')\n      query.equalTo('type', type)\n      query.equalTo('id', id)\n      query.equalTo('ukey', options.key)\n      return (await query.find()).map(toJSON)[0]\n    },\n    remove: async function(type, id) {\n      let data = await this.get(type, id)\n      if (data.objectId) {\n        return AV.Query.doCloudQuery(\n          `delete from Markme where objectId=${JSON.stringify(data.objectId)}`\n        )\n      }\n    },\n    getAll: async function(type) {\n      const query = new AV.Query('Markme')\n      query.equalTo('type', type)\n      query.equalTo('ukey', options.key)\n      return (await query.find()).map(toJSON)\n    },\n    getTotal: async function(type) {\n      const query = new AV.Query('Markme')\n      query.equalTo('type', type)\n      return (await query.find()).map(toJSON)\n    }\n  }\n\n  if (options.enableInitialFill) {\n    storage.getTotal('highlight').then(list => {\n      if (!list || !list.length) {\n        storage.set('null', 'null', null)\n      }\n      emitter.highlight.fill(list)\n    })\n  }\n\n  return emitter\n    .on('highlight-add', async ({ id, ...data }) => {\n      await storage.set('highlight', id, data)\n    })\n    .on('highlight-remove', async id => {\n      await storage.remove('highlight', id)\n    })\n    .on('highlight-change:words', async data => {\n      let old = await storage.get('highlight', data.id)\n      if (old) {\n        old.words = data.words\n        await storage.set('highlight', data.id, old)\n      }\n    })\n    .on('highlight-change:color', async data => {\n      let old = await storage.get('highlight', data.id)\n      if (old) {\n        old.color = data.color\n        await storage.set('highlight', data.id, old)\n      }\n    })\n}\n"],"names":["markInLocalStorage","element","options","location","origin","pathname","applicationId","init","AVOptions","Markme","AV","Object","extend","emitter","mark","toJSON","x","data","json","storage","type","id","get","old","objectId","createWithoutData","set","key","mm","save","Query","equalTo","query","find","map","doCloudQuery","JSON","stringify","enableInitialFill","getTotal","then","list","length","highlight","fill","on","remove","words","color"],"mappings":"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"}