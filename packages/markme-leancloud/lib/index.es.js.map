{"version":3,"file":"index.es.js","sources":["../index.js"],"sourcesContent":["/* eslint-disable indent,no-use-before-define */\n/**\n * @file remoteStorage\n * @author Cuttle Cong\n * @date 2018/5/6\n * @description\n */\n\nimport AV from 'leancloud-storage/live-query'\nimport mark from 'markme'\n\nexport default async function markLeancloud(element, options = {}) {\n  options = {\n    enableInitialFill: true,\n    key: location.origin + location.pathname,\n    AVOptions: {},\n    enableLiveQuery: true,\n    ...options\n  }\n  // AV.\n  AV.applicationId = null\n  AV.init(options.AVOptions)\n\n  const Markme = AV.Object.extend('Markme')\n\n  const emitter = mark(element, options)\n  function toJSON(x) {\n    let { data, ...json } = x.toJSON()\n\n    return {\n      ...json,\n      ...data\n    }\n  }\n\n  const storage = {\n    set: async function(type, id, data) {\n      let old = await this.get(type, id)\n      let mm\n      if (old && old.objectId) {\n        mm = AV.Object.createWithoutData('Markme', old.objectId)\n      } else {\n        mm = new Markme()\n      }\n\n      mm.set('id', id)\n      mm.set('ukey', options.key)\n      mm.set('type', type)\n      mm.set('data', data)\n\n      return mm.save()\n    },\n    get: async function(type, id) {\n      const query = new AV.Query('Markme')\n      query.equalTo('type', type)\n      query.equalTo('id', id)\n      query.equalTo('ukey', options.key)\n      return (await query.find()).map(toJSON)[0]\n    },\n    remove: async function(type, id) {\n      let data = await this.get(type, id)\n      if (data.objectId) {\n        return AV.Query.doCloudQuery(\n          `delete from Markme where objectId=${JSON.stringify(data.objectId)}`\n        )\n      }\n    },\n    getLiveQuery(type) {\n      const query = new AV.Query('Markme')\n      query.equalTo('type', type)\n      query.equalTo('ukey', options.key)\n      return query\n    },\n    getAll: async function(type) {\n      const query = this.getLiveQuery(type)\n      return (await query.find()).map(toJSON)\n    },\n    getTotal: async function(type) {\n      const query = new AV.Query('Markme')\n      query.equalTo('type', type)\n      return (await query.find()).map(toJSON)\n    }\n  }\n\n  // LiveQuery\n  if (options.enableLiveQuery) {\n    const query = storage.getLiveQuery('highlight')\n    const liveQuery = await query.subscribe()\n    liveQuery\n      .on('create', created => {\n        created = created.toJSON()\n        // console.log('created', created)\n        created.id &&\n          created.data &&\n          emitter.highlight.fill(\n            { id: created.id, ...created.data }\n          )\n      })\n      .on('update', updated => {\n        // 自己修改也会触发\n        updated = updated.toJSON()\n        // console.log('updated', updated)\n        const { words, color } = updated.data || {}\n        updated.id && emitter.highlight.change(updated.id, { color, words })\n      })\n      .on('delete', deleted => {\n        deleted = deleted.toJSON()\n        // console.log('deleted', deleted)\n        emitter.highlight.remove(deleted.id)\n      })\n  }\n\n  emitter\n    .on('highlight-add', async ({ id, ...data }) => {\n      console.warn('highlight-add')\n      await storage.set('highlight', id, data)\n    })\n    .on('highlight-remove', async id => {\n      storage.remove('highlight', id)\n    })\n    .on('highlight-change:words', async data => {\n      console.warn('highlight-change:words')\n      let old = await storage.get('highlight', data.id)\n      if (old) {\n        old.words = data.words\n        await storage.set('highlight', data.id, old)\n      }\n    })\n    .on('highlight-change:color', async data => {\n      console.warn('highlight-change:color')\n      let old = await storage.get('highlight', data.id)\n      if (old) {\n        old.color = data.color\n        await storage.set('highlight', data.id, old)\n      }\n    })\n    .on('highlight-match-fail', async id => {\n      await storage.remove('highlight', id)\n    })\n\n  if (options.enableInitialFill) {\n    let list = await storage.getAll('highlight')\n    // if (!list || !list.length) {\n    //   storage.set('null', 'null', null)\n    // }\n    emitter.highlight.fill(list)\n  }\n\n  return emitter\n}\n"],"names":["element","options","toJSON","x","data","json","location","origin","pathname","applicationId","init","AVOptions","AV","Object","extend","mark","type","id","get","old","objectId","createWithoutData","Markme","set","key","mm","save","Query","equalTo","query","find","map","doCloudQuery","JSON","stringify","getLiveQuery","enableLiveQuery","storage","subscribe","on","created","emitter","highlight","fill","updated","words","color","change","deleted","remove","warn","enableInitialFill","getAll","list","markLeancloud"],"mappings":"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"}